name: CI

'on':
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    env:
      CARGO_TERM_COLOR: always
      BUILD_PROFILE: debug
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - name: Setup Rust
        uses: leynos/shared-actions/.github/actions/setup-rust@5901b68f4150ef6edd4e8c733d382d82396998e5
      - name: Format
        run: make check-fmt
      - name: Markdown lint
        uses: DavidAnson/markdownlint-cli2-action@992badcdf24e3b8eb7e87ff9287fe931bcb00c6e
        with:
          globs: |
            **/*.md
            !**/target/**
            !**/dist/**
      - name: Lint
        run: make lint
      - name: Test and Measure Coverage
        uses: leynos/shared-actions/.github/actions/generate-coverage@5901b68f4150ef6edd4e8c733d382d82396998e5
        with:
          output-path: coverage.xml
          format: cobertura
      - name: Set up Python
        uses: actions/setup-python@82c7e631bb3cdc910f68e0081d67478d79c6982d
        with:
          python-version: '3.11'
      - name: Install maturin
        run: python -m pip install --upgrade pip maturin
      - name: Build Python wheel
        shell: bash
        env:
          TEI_PY_BUILD_EXTENSION: "1"
        run: |
          set -euo pipefail
          rm -f dist/tei_rapporteur-*.whl
          maturin build --release --manifest-path tei-py/Cargo.toml --out dist
          shopt -s nullglob
          wheels=(dist/tei_rapporteur-*.whl)
          if [[ ${#wheels[@]} -ne 1 ]]; then
              echo "Expected exactly one tei_rapporteur wheel, found ${#wheels[@]}" >&2
              ls dist
              exit 1
          fi
          echo "WHEEL_PATH=${wheels[0]}" >> "$GITHUB_ENV"
      - name: Install Python wheel
        run: python -m pip install "$WHEEL_PATH"
      - name: Smoke test tei_rapporteur module
        run: python -c "import tei_rapporteur as tr; print(tr.__version__)"
      - name: Upload coverage data to CodeScene
        env:
          CS_ACCESS_TOKEN: ${{ secrets.CS_ACCESS_TOKEN }}
        if: ${{ env.CS_ACCESS_TOKEN }}
        uses: leynos/shared-actions/.github/actions/upload-codescene-coverage@5901b68f4150ef6edd4e8c733d382d82396998e5
        with:
          format: cobertura
          access-token: ${{ env.CS_ACCESS_TOKEN }}
          installer-checksum: ${{ vars.CODESCENE_CLI_SHA256 }}
